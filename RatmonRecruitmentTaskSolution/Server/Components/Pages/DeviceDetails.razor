@page "/device/{DeviceId}"
@using Microsoft.AspNetCore.Authorization
@using Server.Components.Shared
@using Server.Data.Models
@using Server.Services
@using System.Text.Json
@using global::Shared
@rendermode InteractiveServer

@inject NavigationManager NavigationManager
@inject DeviceService DeviceService
@inject DeviceDataService deviceDataService
@inject DialogService DialogService

@attribute [Authorize]

@if (currentDevice is not null)
{
    <PageTitle>Device - @currentDevice.Name</PageTitle>
}
else
{
    <PageTitle>Loading data...</PageTitle>
}


<RadzenRow>
    <RadzenColumn Size="12">
        <RadzenText TextStyle="TextStyle.DisplayH3">
            @if (currentDevice == null)
            {
                <RadzenSkeleton />
            }
            else
            {
                @(currentDevice.Name)
            }
        </RadzenText>
    </RadzenColumn>
    <RadzenColumn Size="12">
        <RadzenCard>
            <RadzenRow>
                <RadzenColumn Size="12" SizeLG="6">
                    <RadzenStack Orientation="Radzen.Orientation.Vertical">
                        <RadzenLabel>From:</RadzenLabel>
                        <RadzenDatePicker ValueChanged=@(async (DateTime dt) => await StartDateTimeChanged(dt)) Value=@StartDate ShowTime="true" ShowSeconds="true" HoursStep="1" MinutesStep="5" SecondsStep="10" DateFormat="MM/dd/yyyy HH:mm" Name="Start Date" />
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeLG="6">
                    <RadzenStack Orientation="Radzen.Orientation.Vertical">
                        <RadzenLabel>To:</RadzenLabel>
                        <RadzenDatePicker ValueChanged=@(async (DateTime dt) => await EndDateTimeChanged(dt)) Value=@EndDate ShowTime="true" ShowSeconds="true" HoursStep="1" MinutesStep="5" SecondsStep="10" DateFormat="MM/dd/yyyy HH:mm" Name="End Date">
                            <FooterTemplate>
                                <RadzenButton Click=@(async args => await EndDateTimeChanged(DateTime.Now)) Text="Now" Style="width: 100%;" class="rz-my-4" />
                            </FooterTemplate>
                        </RadzenDatePicker>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="12">
        @if (currentDevice == null)
        {
            <RadzenSkeleton />
        }
        else
        {
            @switch (currentDevice.Type)
            {
                case DeviceType.MOUSE2:
                    <Server.Components.DeviceDataQuickViews.DDQV_MOUSE2 Device=@currentDevice DeviceData=@currentDeviceData Latest=@currentDeviceData.Count DisableAutoUpdate="true" />
                    break;
                case DeviceType.MOUSE2B:
                    <Server.Components.DeviceDataQuickViews.DDQV_MOUSE2B Device=@currentDevice DeviceData=@currentDeviceData Latest=@currentDeviceData.Count DisableAutoUpdate="true" />
                    break;
                case DeviceType.MOUSECOMBO:
                    <Server.Components.DeviceDataQuickViews.DDQV_MOUSECOMBO Device=@currentDevice DeviceData=@currentDeviceData Latest=@currentDeviceData.Count DisableAutoUpdate="true" />
                    break;
                case DeviceType.MAS2:
                    <Server.Components.DeviceDataQuickViews.DDQV_MAS2 Device=@currentDevice DeviceData=@currentDeviceData Latest=@currentDeviceData.Count DisableAutoUpdate="true" />
                    break;
            }
        }
    </RadzenColumn>
    <RadzenColumn Size="12">
        @if (currentDevice is null)
        {
            <RadzenSkeleton />
        }
        else
        {
            <RadzenDataGrid AllowFiltering="false" AllowColumnResize="true" AllowVirtualization="true" AllowSorting="true" AllowAlternatingRows="false" AllowPaging="false" Style="height:1000px"
                            Data="@currentDeviceData" ColumnWidth="300px" TItem="DeviceData">
                <Columns>
                    <RadzenDataGridColumn Property="@nameof(DeviceData.Id)" Title="id" Width="100px" />
                    <RadzenDataGridColumn Property="@nameof(DeviceData.Timestamp)" Title="Timestamp" Sortable="true">
                        <Template Context="data">
                            @(data.Timestamp.ToLocalTime().ToString("G"))
                        </Template>
                    </RadzenDataGridColumn>
                    @switch (currentDevice.Type)
                    {
                        case DeviceType.MOUSE2:
                            <RadzenDataGridColumn Property="@nameof(DeviceData_MOUSE2.Voltage)" Title="Voltage" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                                <Template Context="data">
                                    @((data.Data as DeviceData_MOUSE2).Voltage)
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn Property="@nameof(DeviceData_MOUSE2.Resistance)" Title="Resistance" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                                <Template Context="data">
                                    @((data.Data as DeviceData_MOUSE2).Resistance)
                                </Template>
                            </RadzenDataGridColumn>
                            break;
                        case DeviceType.MOUSE2B:
                            <RadzenDataGridColumn Property="@nameof(DeviceData_MOUSE2B.Voltage)" Title="Voltage" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                                <Template Context="data">
                                    @((data.Data as DeviceData_MOUSE2B).Voltage)
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn Property="@nameof(DeviceData_MOUSE2B.Resistance)" Title="Resistance" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                                <Template Context="data">
                                    @((data.Data as DeviceData_MOUSE2B).Resistance)
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn Property="@nameof(DeviceData_MOUSE2B.LeakLocation)" Title="Leak Location" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                                <Template Context="data">
                                    @((data.Data as DeviceData_MOUSE2B).LeakLocation)
                                </Template>
                            </RadzenDataGridColumn>
                            break;
                        case DeviceType.MOUSECOMBO:

                            <RadzenDataGridColumn Property="@nameof(DeviceData_MOUSECOMBO.Voltage)" Title="Voltage" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                                <Template Context="data">
                                    @((data.Data as DeviceData_MOUSECOMBO).Voltage)
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn Property="@nameof(DeviceData_MOUSECOMBO.Resistance)" Title="Resistance" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                                <Template Context="data">
                                    @((data.Data as DeviceData_MOUSECOMBO).Resistance)
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn Property="@nameof(DeviceData_MOUSECOMBO.Reflectograms)" Title="Reflectogram" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                                <Template Context="data">
                                    <RadzenTextArea Value=@(JsonSerializer.Serialize((data.Data as DeviceData_MOUSECOMBO).Reflectograms)) />

                                </Template>
                            </RadzenDataGridColumn>
                            break;
                        case DeviceType.MAS2:

                            <RadzenDataGridColumn Property="@nameof(DeviceData_MAS2.Temperature)" Title="Temperature" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                                <Template Context="data">
                                    @((data.Data as DeviceData_MAS2).Temperature)
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn Property="@nameof(DeviceData_MAS2.Humidity)" Title="Humidity" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                                <Template Context="data">
                                    @((data.Data as DeviceData_MAS2).Humidity)
                                </Template>
                            </RadzenDataGridColumn>
                            break;
                    }
                </Columns>
            </RadzenDataGrid>
        }
    </RadzenColumn>
</RadzenRow>
